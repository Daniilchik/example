{\rtf1\ansi\ansicpg1251\cocoartf2865
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\fmodern\fcharset0 Courier;\f1\fmodern\fcharset0 Courier-Oblique;}
{\colortbl;\red255\green255\blue255;\red103\green107\blue114;\red23\green23\blue26;\red195\green123\blue90;
\red174\green176\blue183;\red164\green160\blue78;\red78\green112\blue88;\red71\green149\blue242;\red38\green157\blue169;
\red89\green158\blue96;}
{\*\expandedcolortbl;;\csgenericrgb\c40392\c41961\c44706;\csgenericrgb\c9020\c9020\c10196;\csgenericrgb\c76471\c48235\c35294;
\csgenericrgb\c68235\c69020\c71765;\csgenericrgb\c64314\c62745\c30588;\csgenericrgb\c30588\c43922\c34510;\csgenericrgb\c27843\c58431\c94902;\csgenericrgb\c14902\c61569\c66275;
\csgenericrgb\c34902\c61961\c37647;}
\paperw11900\paperh16840\margl1440\margr1440\vieww11520\viewh8400\viewkind0
\pard\tx560\tx1120\tx1680\tx2240\tx2800\tx3360\tx3920\tx4480\tx5040\tx5600\tx6160\tx6720\pardirnatural\partightenfactor0

\f0\fs26 \cf2 \cb3 /*\
 * Licensed to the Apache Software Foundation (ASF) under one\
 * or more contributor license agreements.  See the NOTICE file\
 * distributed with this work for additional information\
 * regarding copyright ownership.  The ASF licenses this file\
 * to you under the Apache License, Version 2.0 (the\
 * "License"); you may not use this file except in compliance\
 * with the License.  You may obtain a copy of the License at\
 *\
 *     http://www.apache.org/licenses/LICENSE-2.0\
 *\
 * Unless required by applicable law or agreed to in writing, software\
 * distributed under the License is distributed on an "AS IS" BASIS,\
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\
 * See the License for the specific language governing permissions and\
 * limitations under the License.\
 */\
\cf4 package \cf5 org.apache.hadoop.ozone.om.ratelimiter;\
\
\cf4 import \cf5 org.junit.jupiter.api.\cf6 Test\cf5 ;\
\
\cf4 import static \cf5 org.junit.jupiter.api.Assertions.
\f1\i assertFalse
\f0\i0 ;\
\cf4 import static \cf5 org.junit.jupiter.api.Assertions.
\f1\i assertTrue
\f0\i0 ;\
\

\f1\i \cf7 /**\
 * Tests for Leaky Bucket Rate Limiter\
 */\

\f0\i0 \cf4 public class \cf5 TestLeakyBucketRateLimiter \{\
\
  \cf6 @Test\
  \cf4 public void \cf8 testAllowsUpToCapacityThenRejects\cf5 () \{\
    LeakyBucketRateLimiter limiter = \cf4 new \cf5 LeakyBucketRateLimiter(\cf9 10\cf5 , \cf9 10\cf5 );\
\
    \cf4 for \cf5 (\cf4 int \cf5 i = \cf9 0\cf5 ; i < \cf9 11\cf5 ; i++) \{\
      
\f1\i assertTrue
\f0\i0 (limiter.tryAcquire(), \cf10 "Request " \cf5 + i + \cf10 " must be allowed"\cf5 );\
    \}\
    
\f1\i assertFalse
\f0\i0 (limiter.tryAcquire(),\
            \cf10 "Request beyond capacity must be rejected"\cf5 );\
  \}\
\
  \cf6 @Test\
  \cf4 public void \cf8 testRespectsRpsOverTime\cf5 () \{\
    \cf4 int \cf5 rps = \cf9 2\cf5 ;\
    \cf4 int \cf5 capacity = \cf9 2\cf5 ;\
    LeakyBucketRateLimiter limiter = \cf4 new \cf5 LeakyBucketRateLimiter(rps, capacity);\
\
    \cf4 int \cf5 allowed = \cf9 0\cf5 ;\
    \cf4 int \cf5 rejected = \cf9 0\cf5 ;\
\
    \cf4 long \cf5 startNanos = System.
\f1\i nanoTime
\f0\i0 ();\
\
    \cf4 long \cf5 durationNanos = \cf9 0\cf5 ;\
    \cf4 while \cf5 (durationNanos < \cf9 1_000_000_000L\cf5 ) \{\
      \cf4 if \cf5 (limiter.tryAcquire()) \{\
        allowed++;\
      \} \cf4 else \cf5 \{\
        rejected++;\
      \}\
      durationNanos = System.
\f1\i nanoTime
\f0\i0 () - startNanos;\
    \}\
\
    \cf4 double \cf5 durationSeconds = durationNanos / \cf9 1_000_000_000.0\cf5 ;\
\
    \cf4 double \cf5 theoreticalMaxAllowed = capacity + rps * durationSeconds;\
\
    
\f1\i assertTrue
\f0\i0 (allowed > \cf9 0\cf5 , \cf10 "Some requests must be allowed"\cf5 );\
    
\f1\i assertTrue
\f0\i0 (rejected > \cf9 0\cf5 , \cf10 "Some requests must eventually be rejected"\cf5 );\
\
    
\f1\i assertTrue
\f0\i0 (allowed <= theoreticalMaxAllowed + \cf9 1\cf5 ,\
            \cf10 "Allowed=" \cf5 + allowed + \cf10 " exceeds theoretical upper bound=" \cf5 +\
                    theoreticalMaxAllowed + \cf10 " with tolerance=" \cf5 + \cf9 1\cf5 );\
  \}\
\}\
\
}